# PanelReader Plugin
Warning! Tested on Arch Linux and Kindle PW. Kumiko and helper process manga functionality is not tested under windows / macos!

A comprehensive panel navigation system for KOReader that provides panel-to-panel navigation with support for both Western (LTR) and Japanese (RTL) reading directions.

## üöÄ Key Features

- **Automatic Page Navigation**: Seamlessly jump between pages when you reach the last/first panel
- **Flicker-Free Transitions**: Smooth panel switching without annoying screen flashes
- **RTL/LTR Support**: Automatically detects reading direction from your panel data
- **Universal JSON Support**: Works with panel data generated by various tools
- **Tap Navigation**: Simple tap zones - left/right edges for navigation, center to exit

## üìñ Quick Start

1. **Install the plugin** in KOReader's plugins directory
2. **Generate panel data** for your manga using Kumiko (see setup guide below)
3. **Open your manga** in KOReader
4. **Enable Integration Mode**: `Tools ‚Üí MoreTools ‚Üí Panel Zoom Integration
5. **Start reading**: Long-press anywhere on the page to enter panel mode
6. **Navigate**: Tap right side (LTR) or left side (RTL) to move between panels/pages

## üõ†Ô∏è Kumiko Setup Guide

Kumiko is panel detection tool that generates the JSON panel data PanelReader uses. You need to install it from the source repository.

### System Requirements

- **Python 3.8 or higher**
- **OpenCV** (the only required dependency)
- **requests** 
- **Git** (to clone the repository)

### Windows Setup

1. **Install Python** (3.8 or higher):
   - Download from [python.org](https://www.python.org/downloads/)
   - Check "Add Python to PATH" during installation

2. **Install OpenCV and requests**:
   ```bash
   # Method 1: Using pip (recommended)
   pip install opencv-python requests
   ```

3. **Clone Kumiko repository (requires Git) (we're using the forked version)**:
   ```bash
   git clone https://github.com/guilherme5ss/quadrinhos.git
   cd quadrinhos
   ```

4. **Install Kumiko**:
   ```bash
   # Add to PATH (optional but recommended)
   echo 'export PATH="'$(pwd)':$PATH"' >> ~/.bashrc
   # Or on Windows, add the folder to your system PATH
   ```

5. **Verify installation**:
   ```bash
   python kumiko --help
   ```

### Linux Setup

1. **Install Python** (if not already installed):
   ```bash
   # Ubuntu/Debian
   sudo apt update
   sudo apt install python3 python3-pip git
   
   # Fedora/CentOS
   sudo dnf install python3 python3-pip git
   
   # Arch Linux
   sudo pacman -S python python-pip git
   ```

2. **Install OpenCV and requests**:
   ```bash
   # Ubuntu/Debian (easiest method)
   sudo apt install python3-opencv
   
   # Alternative: Using pip
   pip3 install opencv-python requests
   
   # Fedora/CentOS
   sudo dnf install python3-opencv requests
   
   # Arch Linux
   sudo pacman -S python-opencv requests
   ``` 

3. **Clone Kumiko repository**:
   ```bash
   git clone https://github.com/guilherme5ss/quadrinhos.git
   cd quadrinhos
   ```

4. **Make Kumiko executable**:
   ```bash
   chmod +x kumiko
   ```

5. **Add to PATH** (optional but recommended):
   ```bash
   echo 'export PATH="'$(pwd)':$PATH"' >> ~/.bashrc
   source ~/.bashrc
   ```

6. **Verify installation**:
   ```bash
   python3 kumiko --help
   ```

### Alternative Installation Methods

#### Manual installation without git
1. Download the repository from [GitHub](https://github.com/guilherme5ss/quadrinhos)
2. Extract the ZIP file
3. Navigate to the extracted folder
4. Follow the steps above for making it executable

### Testing Kumiko

Test your Kumiko installation with any comic page:

```bash
# Test with a single image
python kumiko -i /path/to/your/comic/page.jpg

# Test with debug visualization (opens in browser)
python kumiko -i /path/to/your/comic/page.jpg -b

# Test with right-to-left reading order (for manga)
python kumiko -i /path/to/your/manga/page.jpg --rtl
```

### Expected Output

Kumiko should output html with panels in pixel coordinates [x, y, width, height]. The `process_manga.py` script will convert these to the normalized coordinates (0.0-1.0) that this plugin uses.

### Troubleshooting Kumiko Installation

**"ImportError: No module named 'cv2'"**
- Install OpenCV: `pip install opencv-python` or `sudo apt install python3-opencv`

**"Command not found: kumiko"**
- Add the quadrinhos directory to your PATH
- Or use full path: `/path/to/quadrinhos/kumiko`

**OpenCV installation issues**
- On Ubuntu/Debian: `sudo apt install python3-opencv` is most reliable
- On other systems: `pip install opencv-python` usually works
- For conda users: `conda install opencv`

## üìö Process Manga Script

The `process_manga.py` script automates the entire workflow from manga files to panel data:

### Usage

```bash
python process_manga.py /path/to/your/manga.cbz
```

### What It Does

1. **Extracts** your manga archive (CBZ/CBR/RAR)
2. **Processes** each page with Kumiko to detect panels
3. **Generates** HTML files with panel coordinates
4. **Combines** all data into a single JSON file
5. **Creates** the final panel data in KOReader-compatible format

### Generated JSON Structure

The script creates a `*.json` file with this structure:

```json
{
  "reading_direction": "rtl",
  "total_pages": 2,
  "pages": [
    {
      "page": 1,
      "image": "page1.jpg",
      "panels": [
        {"x": 0.084, "y": 0.0, "w": 0.857, "h": 0.322},
        {"x": 0.299, "y": 0.0, "w": 0.280, "h": 0.322}
      ]
    },
    {
      "page": 2,
      "image": "page2.jpg", 
      "panels": [
        {"x": 0.027, "y": 0.001, "w": 0.946, "h": 0.110}
      ]
    }
  ]
}
```

### Panel Coordinates Explained

- **x, y**: Top-left corner of panel (0.0 to 1.0, relative to page)
- **w, h**: Width and height of panel (0.0 to 1.0, relative to page)
- **Normalized**: All values are percentages of the full page size

## üéÆ Plugin Usage

### Basic Navigation

| Tap Zone | Action | LTR Reading | RTL Reading |
|----------|--------|--------------|-------------|
| Left 30% | Backward | Previous panel/page | Next panel/page |
| Right 30% | Forward | Next panel/page | Previous panel/page |
| Center 40% | Exit | Close panel viewer | Close panel viewer |

### Smart Page Navigation

- **Last panel + forward tap** ‚Üí Automatically goes to next page
- **First panel + backward tap** ‚Üí Automatically goes to previous page

### Reading Flow

1. **Enter panel mode**: Long-press anywhere on the page
2. **Navigate panels**: Tap left/right edges to move between panels
3. **Auto page turn**: When you reach the last panel, tap forward to go to next page
4. **positioning**: 
   - Forward navigation starts at panel 1 of new page
   - Backward navigation starts at last panel of new page

## ‚öôÔ∏è How It Works

### Technical Overview

1. **Panel Detection**: Uses Kumiko to identify panel boundaries
2. **Coordinate Normalization**: Converts pixel coordinates to percentages (0.0-1.0)
3. **JSON Integration**: Loads panel data from structured JSON files
4. **Image Cropping**: Extracts precise panel regions using KOReader's rendering engine
5. **Navigation Logic**: Handles panel-to-panel and panel-to-page transitions

### Key Components

- **`importToggleZoomPanels()`**: Loads and parses JSON panel data
- **`displayCurrentPanel()`**: Renders and displays current panel
- **`changePage(diff)`**: Handles page transitions
- **`PanelViewer:onTap()`**: Processes tap gestures for navigation

## üîß Troubleshooting

### Common Issues

**"No panels found for this page"**
- Ensure `*.json` exists in the same directory as your manga
- Check that the JSON contains the correct page numbers
- Verify the panel coordinates are valid (0.0-1.0 range)

**Page navigation not working**
- Check logs for "PanelZoom: Used ui.paging.onGotoViewRel" messages
- Try different KOReader document formats (CBZ works best)
- Ensure integration mode is enabled

## üéØ Best Practices

1. **High-quality manga**: Use kindle comic converter and use high-resolution scans for better panel detection
2. **Consistent naming**: Keep manga files and JSON in the same directory

## üîÑ Advanced Usage

### Manual JSON Creation

You can create panel JSON files manually or using AI agents or using both Kumiko and AI agents:

```json
{
  "reading_direction": "ltr",
  "total_pages": 1,
  "pages": [
    {
      "page": 1,
      "image": "page1.jpg",
      "panels": [
        {"x": 0.1, "y": 0.1, "w": 0.4, "h": 0.3},
        {"x": 0.6, "y": 0.1, "w": 0.3, "h": 0.3}
      ]
    }
  ]
}
```

### Multiple Manga Support

The plugin automatically loads the correct `*.json` based on:
- Current file location
- File name matching
- Directory structure

## üìö Compatibility

- **Formats**: CBZ, CBT, PDF, and image folders
- **KOReader**: 2024.01 and later
- **Platforms**: Android, Linux, Windows, macOS, Kindle, Kobo
- **Reading directions**: LTR (Western), RTL (Japanese/Chinese)

## ü§ù Contributing

This plugin is designed to work with various panel detection methods. If you have improvements or find issues, the key areas are:

- Page detection reliability
- Tap zone responsiveness  
- Memory usage optimization
- QOL improvements

## üìÑ License

This plugin follows KOReader's licensing terms and is designed to enhance the existing manga reading experience.
